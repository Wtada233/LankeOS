# lpkg 项目优化建议与待办事项 (TODO)

本项目已具备核心功能和良好的测试覆盖率，但在架构健壮性、安全性和现代化方面仍有改进空间。

## 1. 缺陷与安全风险 (Bugs & Security)

- [ ] **实现跨文件的原子数据库更新**：目前 `Cache::write()` 依次写入多个文件（`pkgs`, `files.db` 等），若在写入中途崩溃会导致数据不一致。应考虑合并为一个元数据文件，或引入事务机制。
- [ ] **消除 `std::system` 调用风险**：`TriggerManager::run_all` 中直接使用了 `std::system`。这存在 Shell 注入风险，应改为使用更安全的 `fork/exec` 封装。
- [ ] **完善回滚机制**：目前的 `rollback_files` 仅处理文件的新增和覆盖，不涉及目录权限的恢复或更复杂的元数据状态回退。
- [ ] **处理外部数据同步**：增加一种机制，在执行操作前检测磁盘上的数据库是否被外部修改，避免内存缓存与磁盘数据脱节。

## 2. 架构与可维护性 (Refactoring & Maintenance)

- [ ] **重构 `Cache` 单例**：减少对全局单例的依赖，改为依赖注入（Dependency Injection），以便于进行完全隔离的并行单元测试。
- [ ] **拆分 `package_manager.cpp`**：该文件目前职责过多。建议将 `InstallationTask` 及其子逻辑提取到独立的源文件中，并分离解析逻辑与执行逻辑。
- [ ] **消除路径配置的全局变量**：`config.cpp` 中的 `extern` 全局路径变量应整合进一个配置上下文类（ConfigContext）中，以支持多 Root 环境的线程安全操作。
- [ ] **增强日志系统**：目前日志逻辑分散在 `utils` 中，建议实现一个支持不同日志级别和多输出目标的轻量级 Logger 类。

## 3. 现代化改进 (Modernization)

- [ ] **引入现代构建系统**：考虑从 Makefile 迁移到 **CMake** 或 **Meson**，以更好地管理第三方依赖（如 libcurl, libarchive）并简化跨平台构建配置。
- [ ] **抽象子进程管理**：封装一个更现代的 `Subprocess` 类，利用 C++20 特性处理管道和 I/O 重定向，减少底层的 `fork/exec` 手动操作。
- [ ] **深化 RAII 包装**：在 `archive.cpp` 和 `downloader.cpp` 中，更彻底地封装 C API，减少原始指针在业务逻辑层面的可见度。
- [ ] **使用 C++20 更多特性**：
    *   在依赖解析中进一步利用 `std::ranges`。
    *   考虑使用 `std::expected` (C++23 预览) 或类似的错误处理模式替代部分异常处理，提高逻辑流的可读性。
